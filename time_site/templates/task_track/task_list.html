{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h2>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <form method="get" class="d-flex align-items-center gap-2">
            <label for="status" class="form-label mb-0">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
            <select name="status" id="status" class="form-select" onchange="this.form.submit()">
                <option value="" {% if not request.GET.status %}selected{% endif %}>–í—Å–µ</option>
                <option value="—Å–≤–æ–±–æ–¥–Ω–∞" {% if request.GET.status == '—Å–≤–æ–±–æ–¥–Ω–∞' %}selected{% endif %}>–°–≤–æ–±–æ–¥–Ω—ã–µ</option>
                <option value="–≤ —Ä–∞–±–æ—Ç–µ" {% if request.GET.status == '–≤ —Ä–∞–±–æ—Ç–µ' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="–∑–∞–≤–µ—Ä—à–µ–Ω–∞" {% if request.GET.status == '–∑–∞–≤–µ—Ä—à–µ–Ω–∞' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
            </select>
        </form>

        {% if user.role == "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å" %}
            <div class="text-center mt-4">
                <a href="{% url 'create_task' %}" class="btn btn-success me-2">
                    üìù–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                </a>
            </div>
        {% endif %}
    </div>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–°—Ä–æ–∫</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                <th>–û—Ç–¥–µ–ª</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                <th>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ</th>
            </tr>
        </thead>
        <tbody>
        {% for task in tasks %}
            <tr>
                <td>{{ task.title }}</td>
                <td>{{ task.description }}</td>
                <td>{{ task.due_date }}</td>
                <td>{{ task.get_status_display }}</td>
                <td>{{ task.assigned_to.get_full_name|default:"‚Äî" }}</td>
                <td>{{ task.department.name }}</td>
                <td>
                    {% if user == task.assigned_to and task.status == "–≤ —Ä–∞–±–æ—Ç–µ" %}
                        <a href="{% url 'complete_task' task.id %}" class="btn btn-success btn-sm">–ó–∞–≤–µ—Ä—à–∏—Ç—å</a>
                    {% elif not task.assigned_to %}
                        <a href="{% url 'take_task' task.id %}" class="btn btn-warning btn-sm">–í–∑—è—Ç—å</a>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_authenticated and user.is_manager and not task.assigned_to %}
                        <a href="{% url 'edit_task' task.id %}" class="btn btn-sm btn-warning">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <form action="{% url 'delete_task' task.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?');">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="text-center mt-4">
        <a href="javascript:history.back()" class="btn btn-secondary">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </div>
</div>
{% endblock %}
